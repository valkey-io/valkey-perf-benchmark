AWSTemplateFormatVersion: "2010-09-09"
Description: "Complete Valkey Performance Benchmark Infrastructure with EKS, RDS PostgreSQL, and CloudFront"

Parameters:
  ClusterName:
    Type: String
    Default: valkey-perf-cluster
    Description: Name of the EKS cluster

  NodeInstanceType:
    Type: String
    Default: t4g.small
    AllowedValues:
      [t4g.small, t4g.medium, t4g.large]
    Description: EC2 instance type for EKS worker nodes

  NodeGroupDesiredCapacity:
    Type: Number
    Default: 2
    MinValue: 1
    MaxValue: 10
    Description: Desired number of worker nodes

  NodeGroupMinSize:
    Type: Number
    Default: 1
    MinValue: 1
    MaxValue: 10
    Description: Minimum number of worker nodes

  NodeGroupMaxSize:
    Type: Number
    Default: 4
    MinValue: 1
    MaxValue: 20
    Description: Maximum number of worker nodes

  DBInstanceClass:
    Type: String
    Default: db.t4g.micro
    AllowedValues:
      [
        db.t4g.micro,
        db.t4g.small,
        db.t4g.medium,
      ]
    Description: RDS instance class

  DBAllocatedStorage:
    Type: Number
    Default: 20
    MinValue: 20
    MaxValue: 1000
    Description: RDS allocated storage in GB

  DBMasterUsername:
    Type: String
    Default: postgres
    Description: RDS master username

  DBMasterPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    MaxLength: 128
    Description: RDS master password (8-128 characters)

  Environment:
    Type: String
    Default: production
    AllowedValues: [development, staging, production]
    Description: Environment name

  ProjectName:
    Type: String
    Default: valkey-benchmark
    Description: Project name for resource tagging

  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: EC2 Key Pair for SSH access to worker nodes (must exist in your account)

  GitHubOIDCProviderArn:
    Type: String
    Default: ""
    Description: ARN of the existing GitHub OIDC Provider

  GrafanaAlbDnsName:
    Type: String
    Default: ""
    Description: DNS name of the Grafana ALB created by the AWS Load Balancer Controller (e.g. k8s-grafana-grafanai-XXXXXXXXXX.elb.amazonaws.com)
    AllowedPattern: "^$|([a-z0-9-]+\\.)+elb\\.amazonaws\\.com$"
    ConstraintDescription: Must be empty or a valid AWS ALB hostname (â€¦elb.amazonaws.com)

Conditions:
  HasGitHubOIDCProvider: !Not [!Equals [!Ref GitHubOIDCProviderArn, ""]]
  NeedsGitHubOIDCProvider: !Equals [!Ref GitHubOIDCProviderArn, ""]
  HasGrafanaAlbDns: !Not [!Equals [!Ref GrafanaAlbDnsName, ""]]

Resources:
  # VPC and Networking
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-vpc"
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-igw"
        - Key: Environment
          Value: !Ref Environment

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  # Public Subnets
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-public-subnet-1"
        - Key: kubernetes.io/role/elb
          Value: "1"
        - Key: Environment
          Value: !Ref Environment

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs ""]
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-public-subnet-2"
        - Key: kubernetes.io/role/elb
          Value: "1"
        - Key: Environment
          Value: !Ref Environment

  # Private Subnets
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: 10.0.10.0/24
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-private-subnet-1"
        - Key: kubernetes.io/role/internal-elb
          Value: "1"
        - Key: Environment
          Value: !Ref Environment

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs ""]
      CidrBlock: 10.0.11.0/24
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-private-subnet-2"
        - Key: kubernetes.io/role/internal-elb
          Value: "1"
        - Key: Environment
          Value: !Ref Environment

  # NAT Gateways
  NatGateway1EIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-nat-eip-1"

  NatGateway2EIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-nat-eip-2"

  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway1EIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-nat-1"

  NatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway2EIP.AllocationId
      SubnetId: !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-nat-2"

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-public-routes"

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-private-routes-1"

  DefaultPrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway1

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet1

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-private-routes-2"

  DefaultPrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway2

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      SubnetId: !Ref PrivateSubnet2

  # Security Groups
  EKSClusterSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for EKS cluster
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.0.0.0/16
          Description: Restrict EKS API access to the VPC range
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-eks-cluster-sg"
        - Key: Environment
          Value: !Ref Environment

  EKSNodeSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for EKS worker nodes
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 1025
          ToPort: 65535
          SourceSecurityGroupId: !Ref EKSClusterSecurityGroup
          Description: Allow cluster to communicate with nodes
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref EKSClusterSecurityGroup
          Description: Allow cluster to communicate with nodes on HTTPS
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 10.0.0.0/16
          Description: Allow SSH access from within the VPC
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-eks-node-sg"
        - Key: Environment
          Value: !Ref Environment

  # Security Group for GitHub Actions Runner (if in same VPC)
  GitHubRunnerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for GitHub Actions self-hosted runner
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-github-runner-sg"
        - Key: Environment
          Value: !Ref Environment

  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS PostgreSQL
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref EKSNodeSecurityGroup
          Description: Allow EKS nodes to access PostgreSQL
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref GitHubRunnerSecurityGroup
          Description: Allow GitHub Actions runner to access PostgreSQL (same VPC)
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-rds-sg"
        - Key: Environment
          Value: !Ref Environment

  # IAM Roles
  EKSClusterRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-eks-cluster-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: eks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  RDSMonitoringRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-rds-monitoring-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: monitoring.rds.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  # GitHub OIDC Provider for GitHub Actions (only create if not provided)
  GitHubOIDCProvider:
    Type: AWS::IAM::OIDCProvider
    Condition: NeedsGitHubOIDCProvider
    Properties:
      Url: https://token.actions.githubusercontent.com
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        - 6938fd4d98bab03faadb97b34396831e3780aea1
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-github-oidc-provider"
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for GitHub Actions to push metrics to RDS
  GitHubActionsRDSRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-github-actions-rds-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: !If
                - HasGitHubOIDCProvider
                - !Ref GitHubOIDCProviderArn
                - !GetAtt GitHubOIDCProvider.Arn
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
              StringLike:
                "token.actions.githubusercontent.com:sub": "repo:valkey-io/valkey-perf-benchmark:*"
      Policies:
        - PolicyName: RDSConnect
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - rds-db:connect
                Resource: !Sub "arn:aws:rds-db:${AWS::Region}:${AWS::AccountId}:dbuser:${RDSInstance.DbiResourceId}/*"
              - Effect: Allow
                Action:
                  - rds:DescribeDBInstances
                Resource: !GetAtt RDSInstance.DBInstanceArn
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  EKSNodeRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-eks-node-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
        - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  # EKS Cluster
  EKSCluster:
    Type: AWS::EKS::Cluster
    Properties:
      Name: !Ref ClusterName
      Version: "1.33"
      RoleArn: !GetAtt EKSClusterRole.Arn
      ResourcesVpcConfig:
        SecurityGroupIds:
          - !Ref EKSClusterSecurityGroup
        SubnetIds:
          - !Ref PublicSubnet1
          - !Ref PublicSubnet2
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        EndpointPublicAccess: false
        EndpointPrivateAccess: true
      Logging:
        ClusterLogging:
          EnabledTypes:
            - Type: api
            - Type: audit
            - Type: authenticator
            - Type: controllerManager
            - Type: scheduler
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  # IAM OIDC Provider for EKS
  EKSOIDCProvider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      Url: !GetAtt EKSCluster.OpenIdConnectIssuerUrl
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        - 9e99a48a9960b14926bb7f3b02e22da2b0ab7280 # Root CA thumbprint for EKS
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-eks-oidc-provider"
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for AWS Load Balancer Controller
  AWSLoadBalancerControllerRole:
    Type: AWS::IAM::Role
    DependsOn: EKSOIDCProvider
    Properties:
      RoleName: !Sub "${ProjectName}-aws-load-balancer-controller-role"
      AssumeRolePolicyDocument:
        Fn::Sub:
          - |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "${OIDCProviderArn}"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                      "${IssuerUrl}:aud": "sts.amazonaws.com",
                      "${IssuerUrl}:sub": "system:serviceaccount:kube-system:aws-load-balancer-controller"
                    }
                  }
                }
              ]
            }
          - OIDCProviderArn: !GetAtt EKSOIDCProvider.Arn
            IssuerUrl: !GetAtt EKSCluster.OpenIdConnectIssuerUrl
      ManagedPolicyArns:
        - !Ref AWSLoadBalancerControllerPolicy
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  # IAM Policy for AWS Load Balancer Controller
  AWSLoadBalancerControllerPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub "${ProjectName}-aws-load-balancer-controller-policy"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - iam:CreateServiceLinkedRole
            Resource: "*"
            Condition:
              StringEquals:
                "iam:AWSServiceName": elasticloadbalancing.amazonaws.com
          - Effect: Allow
            Action:
              - ec2:DescribeAccountAttributes
              - ec2:DescribeAddresses
              - ec2:DescribeAvailabilityZones
              - ec2:DescribeInternetGateways
              - ec2:DescribeVpcs
              - ec2:DescribeVpcPeeringConnections
              - ec2:DescribeSubnets
              - ec2:DescribeSecurityGroups
              - ec2:DescribeInstances
              - ec2:DescribeNetworkInterfaces
              - ec2:DescribeTags
              - ec2:GetCoipPoolUsage
              - ec2:DescribeCoipPools
              - elasticloadbalancing:DescribeLoadBalancers
              - elasticloadbalancing:DescribeLoadBalancerAttributes
              - elasticloadbalancing:DescribeListeners
              - elasticloadbalancing:DescribeListenerCertificates
              - elasticloadbalancing:DescribeSSLPolicies
              - elasticloadbalancing:DescribeRules
              - elasticloadbalancing:DescribeTargetGroups
              - elasticloadbalancing:DescribeTargetGroupAttributes
              - elasticloadbalancing:DescribeTargetHealth
              - elasticloadbalancing:DescribeTags
            Resource: "*"
          - Effect: Allow
            Action:
              - cognito-idp:DescribeUserPoolClient
              - acm:ListCertificates
              - acm:DescribeCertificate
              - iam:ListServerCertificates
              - iam:GetServerCertificate
              - waf-regional:GetWebACL
              - waf-regional:GetWebACLForResource
              - waf-regional:AssociateWebACL
              - waf-regional:DisassociateWebACL
              - wafv2:GetWebACL
              - wafv2:GetWebACLForResource
              - wafv2:AssociateWebACL
              - wafv2:DisassociateWebACL
              - shield:GetSubscriptionState
              - shield:DescribeProtection
              - shield:CreateProtection
              - shield:DeleteProtection
            Resource: "*"
          - Effect: Allow
            Action:
              - ec2:AuthorizeSecurityGroupIngress
              - ec2:RevokeSecurityGroupIngress
              - ec2:CreateSecurityGroup
            Resource: "*"
          - Effect: Allow
            Action:
              - ec2:CreateTags
            Resource: "arn:aws:ec2:*:*:security-group/*"
            Condition:
              StringEquals:
                "ec2:CreateAction": CreateSecurityGroup
              "Null":
                "aws:RequestTag/elbv2.k8s.aws/cluster": "false"
          - Effect: Allow
            Action:
              - ec2:CreateTags
              - ec2:DeleteTags
            Resource: "arn:aws:ec2:*:*:security-group/*"
            Condition:
              "Null":
                "aws:RequestTag/elbv2.k8s.aws/cluster": "true"
                "aws:ResourceTag/elbv2.k8s.aws/cluster": "false"
          - Effect: Allow
            Action:
              - elasticloadbalancing:CreateLoadBalancer
              - elasticloadbalancing:CreateTargetGroup
            Resource: "*"
            Condition:
              "Null":
                "aws:RequestTag/elbv2.k8s.aws/cluster": "false"
          - Effect: Allow
            Action:
              - elasticloadbalancing:CreateListener
              - elasticloadbalancing:DeleteListener
              - elasticloadbalancing:CreateRule
              - elasticloadbalancing:DeleteRule
            Resource: "*"
          - Effect: Allow
            Action:
              - elasticloadbalancing:AddTags
              - elasticloadbalancing:RemoveTags
            Resource:
              - "arn:aws:elasticloadbalancing:*:*:targetgroup/*/*"
              - "arn:aws:elasticloadbalancing:*:*:loadbalancer/net/*/*"
              - "arn:aws:elasticloadbalancing:*:*:loadbalancer/app/*/*"
            Condition:
              "Null":
                "aws:RequestTag/elbv2.k8s.aws/cluster": "true"
                "aws:ResourceTag/elbv2.k8s.aws/cluster": "false"
          - Effect: Allow
            Action:
              - elasticloadbalancing:AddTags
              - elasticloadbalancing:RemoveTags
            Resource:
              - "arn:aws:elasticloadbalancing:*:*:listener/net/*/*/*"
              - "arn:aws:elasticloadbalancing:*:*:listener/app/*/*/*"
              - "arn:aws:elasticloadbalancing:*:*:listener-rule/net/*/*/*"
              - "arn:aws:elasticloadbalancing:*:*:listener-rule/app/*/*/*"
          - Effect: Allow
            Action:
              - elasticloadbalancing:ModifyLoadBalancerAttributes
              - elasticloadbalancing:SetIpAddressType
              - elasticloadbalancing:SetSecurityGroups
              - elasticloadbalancing:SetSubnets
              - elasticloadbalancing:DeleteLoadBalancer
              - elasticloadbalancing:ModifyTargetGroup
              - elasticloadbalancing:ModifyTargetGroupAttributes
              - elasticloadbalancing:DeleteTargetGroup
            Resource: "*"
            Condition:
              "Null":
                "aws:ResourceTag/elbv2.k8s.aws/cluster": "false"
          - Effect: Allow
            Action:
              - elasticloadbalancing:RegisterTargets
              - elasticloadbalancing:DeregisterTargets
            Resource: "arn:aws:elasticloadbalancing:*:*:targetgroup/*/*"
          - Effect: Allow
            Action:
              - elasticloadbalancing:SetWebAcl
              - elasticloadbalancing:ModifyListener
              - elasticloadbalancing:AddListenerCertificates
              - elasticloadbalancing:RemoveListenerCertificates
              - elasticloadbalancing:ModifyRule
            Resource: "*"

  # IAM Role for EBS CSI Driver
  EBSCSIDriverRole:
    Type: AWS::IAM::Role
    DependsOn: EKSOIDCProvider
    Properties:
      RoleName: !Sub "${ProjectName}-ebs-csi-driver-role"
      AssumeRolePolicyDocument:
        Fn::Sub:
          - |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "${OIDCProviderArn}"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                      "${IssuerUrl}:aud": "sts.amazonaws.com",
                      "${IssuerUrl}:sub": "system:serviceaccount:kube-system:ebs-csi-controller-sa"
                    }
                  }
                }
              ]
            }
          - OIDCProviderArn: !GetAtt EKSOIDCProvider.Arn
            IssuerUrl: !GetAtt EKSCluster.OpenIdConnectIssuerUrl
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  # IAM Role for Cluster Autoscaler
  ClusterAutoscalerRole:
    Type: AWS::IAM::Role
    DependsOn: EKSOIDCProvider
    Properties:
      RoleName: !Sub "${ProjectName}-cluster-autoscaler-role"
      AssumeRolePolicyDocument:
        Fn::Sub:
          - |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "${OIDCProviderArn}"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                      "${IssuerUrl}:aud": "sts.amazonaws.com",
                      "${IssuerUrl}:sub": "system:serviceaccount:kube-system:cluster-autoscaler"
                    }
                  }
                }
              ]
            }
          - OIDCProviderArn: !GetAtt EKSOIDCProvider.Arn
            IssuerUrl: !GetAtt EKSCluster.OpenIdConnectIssuerUrl
      ManagedPolicyArns:
        - !Ref ClusterAutoscalerPolicy
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  # IAM Policy for Cluster Autoscaler
  ClusterAutoscalerPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub "${ProjectName}-cluster-autoscaler-policy"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - autoscaling:DescribeAutoScalingGroups
              - autoscaling:DescribeAutoScalingInstances
              - autoscaling:DescribeLaunchConfigurations
              - autoscaling:DescribeScalingActivities
              - autoscaling:DescribeTags
              - ec2:DescribeImages
              - ec2:DescribeInstanceTypes
              - ec2:DescribeLaunchTemplateVersions
              - ec2:GetInstanceTypesFromInstanceRequirements
              - eks:DescribeNodegroup
            Resource: "*"
          - Effect: Allow
            Action:
              - autoscaling:SetDesiredCapacity
              - autoscaling:TerminateInstanceInAutoScalingGroup
            Resource: "*"
            Condition:
              StringEquals:
                "autoscaling:ResourceTag/k8s.io/cluster-autoscaler/enabled": "true"
                "autoscaling:ResourceTag/kubernetes.io/cluster/${ClusterName}": "owned"

  EKSNodeLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub "${ProjectName}-node-lt"
      LaunchTemplateData:
        KeyName: !Ref KeyPairName
        SecurityGroupIds:
          - !Ref EKSNodeSecurityGroup
        MetadataOptions:
          HttpTokens: required
          HttpPutResponseHopLimit: 2
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Environment
                Value: !Ref Environment
              - Key: Project
                Value: !Ref ProjectName

  # EKS Node Group
  EKSNodeGroup:
    Type: AWS::EKS::Nodegroup
    DependsOn: EKSCluster
    Properties:
      ClusterName: !Ref ClusterName
      NodegroupName: !Sub "${ProjectName}-node-group"
      NodeRole: !GetAtt EKSNodeRole.Arn
      InstanceTypes:
        - !Ref NodeInstanceType
      AmiType: AL2023_ARM_64_STANDARD
      CapacityType: ON_DEMAND
      Subnets:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      LaunchTemplate:
        Id: !Ref EKSNodeLaunchTemplate
        Version: !GetAtt EKSNodeLaunchTemplate.LatestVersionNumber
      ScalingConfig:
        MinSize: !Ref NodeGroupMinSize
        MaxSize: !Ref NodeGroupMaxSize
        DesiredSize: !Ref NodeGroupDesiredCapacity
      UpdateConfig:
        MaxUnavailable: 1
      Tags:
        Environment: !Ref Environment
        Project: !Ref ProjectName
        "k8s.io/cluster-autoscaler/enabled": "true"
        "k8s.io/cluster-autoscaler/valkey-perf-cluster": "owned"

  # EBS CSI Driver Add-on
  EBSCSIDriverAddon:
    Type: AWS::EKS::Addon
    DependsOn:
      - EKSNodeGroup
      - EBSCSIDriverRole
    Properties:
      ClusterName: !Ref ClusterName
      AddonName: aws-ebs-csi-driver
      AddonVersion: v1.36.0-eksbuild.1
      ServiceAccountRoleArn: !GetAtt EBSCSIDriverRole.Arn
      ResolveConflicts: OVERWRITE
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  # RDS Subnet Group - Private-only subnets for database isolation
  RDSSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: !Sub "${ProjectName}-rds-subnet-group"
      DBSubnetGroupDescription: Subnet group for RDS PostgreSQL
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-rds-subnet-group"
        - Key: Environment
          Value: !Ref Environment

  # RDS Parameter Group
  RDSParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      DBParameterGroupName: !Sub "${ProjectName}-postgres-params"
      Description: Parameter group for PostgreSQL optimized for Grafana
      Family: postgres17
      Parameters:
        shared_preload_libraries: "pg_stat_statements"
        log_statement: "all"
        log_min_duration_statement: "1000"
        max_connections: "200"
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-postgres-params"
        - Key: Environment
          Value: !Ref Environment

  # RDS Instance
  RDSInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub "${ProjectName}-postgres"
      DBInstanceClass: !Ref DBInstanceClass
      Engine: postgres
      EngineVersion: "17"
      AllocatedStorage: !Ref DBAllocatedStorage
      StorageType: gp3
      StorageEncrypted: true
      MasterUsername: !Ref DBMasterUsername
      MasterUserPassword: !Ref DBMasterPassword
      DBName: grafana
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      DBSubnetGroupName: !Ref RDSSubnetGroup
      DBParameterGroupName: !Ref RDSParameterGroup
      BackupRetentionPeriod: 7
      PreferredBackupWindow: "03:00-04:00"
      PreferredMaintenanceWindow: "sun:04:00-sun:05:00"
      MultiAZ: false
      PubliclyAccessible: false
      DeletionProtection: false
      EnablePerformanceInsights: true
      PerformanceInsightsRetentionPeriod: 7
      MonitoringInterval: 60
      MonitoringRoleArn: !GetAtt RDSMonitoringRole.Arn
      EnableIAMDatabaseAuthentication: true
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-postgres"
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  # CloudFront Distribution
  # Supply the actual ALB DNS name via the GrafanaAlbDnsName parameter (GitHub workflow/self-hosted runners can discover it via
  # aws elbv2 describe-load-balancers) so the distribution always points at the live ingress. Continue to run dashboards/secure-alb-for-cloudfront.sh
  # to restrict the ALB security group to the CloudFront managed prefix list.
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Condition: HasGrafanaAlbDns
    Properties:
      DistributionConfig:
        Comment: !Sub "CloudFront distribution for ${ProjectName} Grafana dashboards"
        Enabled: true
        HttpVersion: http2and3
        IPV6Enabled: true
        PriceClass: PriceClass_100
        Origins:
          - Id: grafana-alb-origin
            DomainName: !Ref GrafanaAlbDnsName
            CustomOriginConfig:
              HTTPPort: 80
              HTTPSPort: 443
              OriginProtocolPolicy: http-only
              OriginReadTimeout: 30
              OriginKeepaliveTimeout: 5
        DefaultCacheBehavior:
          TargetOriginId: grafana-alb-origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: [HEAD, DELETE, POST, GET, OPTIONS, PUT, PATCH]
          CachedMethods: [HEAD, GET]
          Compress: true
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad # CachingDisabled
          OriginRequestPolicyId: 216adef6-5c7f-47e4-b989-5492eafa07d3 # AllViewerExceptHostHeader
        CacheBehaviors:
          - PathPattern: "/public-dashboards/*"
            TargetOriginId: grafana-alb-origin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods: [HEAD, GET]
            CachedMethods: [HEAD, GET]
            Compress: true
            CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6 # CachingOptimized
          - PathPattern: "/api/*"
            TargetOriginId: grafana-alb-origin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods: [HEAD, DELETE, POST, GET, OPTIONS, PUT, PATCH]
            CachedMethods: [HEAD, GET]
            Compress: true
            CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad # CachingDisabled
            OriginRequestPolicyId: 216adef6-5c7f-47e4-b989-5492eafa07d3 # AllViewerExceptHostHeader
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-cloudfront"
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub "${AWS::StackName}-VPC-ID"

  EKSClusterName:
    Description: EKS Cluster Name
    Value: !Ref EKSCluster
    Export:
      Name: !Sub "${AWS::StackName}-EKS-Cluster-Name"

  EKSClusterEndpoint:
    Description: EKS Cluster Endpoint
    Value: !GetAtt EKSCluster.Endpoint
    Export:
      Name: !Sub "${AWS::StackName}-EKS-Cluster-Endpoint"

  EKSClusterArn:
    Description: EKS Cluster ARN
    Value: !GetAtt EKSCluster.Arn
    Export:
      Name: !Sub "${AWS::StackName}-EKS-Cluster-ARN"

  RDSEndpoint:
    Description: RDS PostgreSQL Endpoint
    Value: !GetAtt RDSInstance.Endpoint.Address
    Export:
      Name: !Sub "${AWS::StackName}-RDS-Endpoint"

  RDSPort:
    Description: RDS PostgreSQL Port
    Value: !GetAtt RDSInstance.Endpoint.Port
    Export:
      Name: !Sub "${AWS::StackName}-RDS-Port"

  CloudFrontDomainName:
    Description: CloudFront Distribution Domain Name
    Condition: HasGrafanaAlbDns
    Value: !GetAtt CloudFrontDistribution.DomainName
    Export:
      Name: !Sub "${AWS::StackName}-CloudFront-Domain"

  CloudFrontDistributionId:
    Description: CloudFront Distribution ID
    Condition: HasGrafanaAlbDns
    Value: !Ref CloudFrontDistribution
    Export:
      Name: !Sub "${AWS::StackName}-CloudFront-ID"

  AWSLoadBalancerControllerRoleArn:
    Description: AWS Load Balancer Controller IAM Role ARN
    Value: !GetAtt AWSLoadBalancerControllerRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ALB-Controller-Role-ARN"

  EBSCSIDriverRoleArn:
    Description: EBS CSI Driver IAM Role ARN
    Value: !GetAtt EBSCSIDriverRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-EBS-CSI-Role-ARN"

  ClusterAutoscalerRoleArn:
    Description: Cluster Autoscaler IAM Role ARN
    Value: !GetAtt ClusterAutoscalerRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-Cluster-Autoscaler-Role-ARN"

  EKSOIDCProviderArn:
    Description: EKS OIDC Provider ARN
    Value: !GetAtt EKSOIDCProvider.Arn
    Export:
      Name: !Sub "${AWS::StackName}-OIDC-Provider-ARN"

  GitHubOIDCProviderArn:
    Description: GitHub OIDC Provider ARN (provided or created)
    Value: !If
      - HasGitHubOIDCProvider
      - !Ref GitHubOIDCProviderArn
      - !GetAtt GitHubOIDCProvider.Arn
    Export:
      Name: !Sub "${AWS::StackName}-GitHub-OIDC-Provider-ARN"

  GitHubActionsRoleArn:
    Description: GitHub Actions IAM Role ARN for RDS access
    Value: !GetAtt GitHubActionsRDSRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-GitHub-Actions-Role-ARN"

  DatabaseName:
    Description: RDS Database Name
    Value: grafana
    Export:
      Name: !Sub "${AWS::StackName}-Database-Name"

  PublicSubnets:
    Description: Public Subnet IDs
    Value: !Join [",", [!Ref PublicSubnet1, !Ref PublicSubnet2]]
    Export:
      Name: !Sub "${AWS::StackName}-Public-Subnets"

  PrivateSubnets:
    Description: Private Subnet IDs
    Value: !Join [",", [!Ref PrivateSubnet1, !Ref PrivateSubnet2]]
    Export:
      Name: !Sub "${AWS::StackName}-Private-Subnets"

  RDSMonitoringRoleArn:
    Description: RDS Monitoring IAM Role ARN
    Value: !GetAtt RDSMonitoringRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-RDS-Monitoring-Role-ARN"
