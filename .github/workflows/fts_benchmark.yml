name: FTS Continuous Benchmark

on:
  workflow_dispatch:
    inputs:
      valkey_search_branch:
        description: "valkey-search branch to test"
        required: false
        default: "fulltext"
        type: string
      test_groups:
        description: "Test groups to run (e.g., '1' or '1,2,3')"
        required: false
        default: "1"
        type: string
      num_runs:
        description: "Number of benchmark runs"
        required: false
        default: "1"
        type: string
      enable_profiling:
        description: "Enable performance profiling"
        required: false
        default: "false"
        type: boolean
  schedule:
    - cron: "0 0 * * 0"  # Weekly on Sunday at midnight UTC

concurrency:
  group: ec2-fts-benchmarking
  cancel-in-progress: false

defaults:
  run:
    shell: "bash -Eeuo pipefail -x {0}"

permissions:
  id-token: write
  contents: read

jobs:
  fts_continuous_benchmark:
    env:
      VALKEY_BRANCH: unstable
      VALKEY_SEARCH_BRANCH: ${{ inputs.valkey_search_branch || 'fulltext' }}
      TEST_GROUPS: ${{ inputs.test_groups || '1' }}
      NUM_RUN: ${{ inputs.num_runs || '1' }}
      ENABLE_PROFILING: ${{ inputs.enable_profiling || 'false' }}
    runs-on: [self-hosted, ec2-fts-benchmarking]
    timeout-minutes: 480
    
    steps:
      - name: Set up Python
        uses: kishaningithub/setup-python-amazon-linux@63dc7bd642c6a564d0a93dd4b1cbe3e448ce3621
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Checkout Valkey
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          repository: valkey-io/valkey
          ref: ${{ env.VALKEY_BRANCH }}
          fetch-depth: 0
          path: valkey

      - name: Checkout valkey-search
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          repository: valkey-io/valkey-search
          ref: ${{ env.VALKEY_SEARCH_BRANCH }}
          fetch-depth: 0
          path: valkey-search

      - name: Checkout Valkey Benchmark Framework
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          path: valkey-perf-benchmark

      - name: Install dependencies
        working-directory: valkey-perf-benchmark
        run: |
          sudo dnf groupinstall "Development Tools" -y
          sudo dnf install -y gcc gcc-c++ make python3-devel openssl-devel bzip2-devel libffi-devel bzip2 perl
          pip install -r requirements.txt

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}

      - name: Cleanup incomplete commits from previous runs
        working-directory: valkey-perf-benchmark
        run: |
          PGPASSWORD=$(aws rds generate-db-auth-token \
            --hostname ${{ secrets.POSTGRESQL_ENDPOINT }} \
            --port 5432 \
            --region ${{ secrets.AWS_REGION }} \
            --username ${{ secrets.RDS_USERNAME }})
          python utils/postgres_track_commits.py cleanup \
            --host ${{ secrets.POSTGRESQL_ENDPOINT }} \
            --port 5432 \
            --database ${{ secrets.RDS_DATABASE }} \
            --username ${{ secrets.RDS_USERNAME }} \
            --password "$PGPASSWORD"

      - name: Setup FTS datasets
        working-directory: valkey-perf-benchmark
        run: |
          echo "Checking for existing FTS datasets..."
          if [[ -f "datasets/field_explosion_50k.xml" ]] && \
             [[ -f "datasets/search_terms.csv" ]] && \
             [[ -f "datasets/proximity_phrases.csv" ]]; then
            echo "✓ FTS datasets already exist, skipping generation"
            ls -lh datasets/*.{xml,csv} 2>/dev/null || true
          else
            echo "Generating FTS datasets..."
            python scripts/setup_datasets.py
            echo "✓ Dataset generation complete"
            ls -lh datasets/*.{xml,csv} 2>/dev/null || true
          fi

      - name: Get valkey-search commit SHA
        id: search_commit
        working-directory: valkey-search
        run: |
          SEARCH_SHA=$(git rev-parse HEAD)
          echo "search_sha=$SEARCH_SHA" >> "$GITHUB_OUTPUT"
          echo "Testing valkey-search commit: $SEARCH_SHA"

      - name: Mark commit as in progress
        working-directory: valkey-perf-benchmark
        run: |
          PGPASSWORD=$(aws rds generate-db-auth-token \
            --hostname ${{ secrets.POSTGRESQL_ENDPOINT }} \
            --port 5432 \
            --region ${{ secrets.AWS_REGION }} \
            --username ${{ secrets.RDS_USERNAME }})
          python utils/postgres_track_commits.py mark \
            --host ${{ secrets.POSTGRESQL_ENDPOINT }} \
            --port 5432 \
            --database ${{ secrets.RDS_DATABASE }} \
            --username ${{ secrets.RDS_USERNAME }} \
            --password "$PGPASSWORD" \
            --repo ../valkey-search \
            --status in_progress \
            --config-file configs/fts-benchmarks.json \
            ${{ steps.search_commit.outputs.search_sha }}

      - name: Build Valkey
        working-directory: valkey
        run: |
          echo "Building Valkey..."
          make distclean || true
          make BUILD_TLS=yes -j$(nproc)
          if [[ -f "src/valkey-server" ]] && [[ -f "src/valkey-benchmark" ]]; then
            echo "✓ Valkey build successful"
            ./src/valkey-server --version
          else
            echo "✗ Valkey build failed"
            exit 1
          fi

      - name: Build valkey-search module
        working-directory: valkey-search
        run: |
          echo "Building valkey-search module..."
          make distclean || true
          make BUILD_TLS=yes -j$(nproc)
          if [[ -f ".build-release/libsearch.so" ]]; then
            echo "✓ valkey-search module build successful"
            ls -lh .build-release/libsearch.so
          else
            echo "✗ valkey-search module build failed"
            exit 1
          fi

      - name: Start Valkey server with search module
        working-directory: valkey-perf-benchmark
        run: |
          # Read server parameters from config
          SERVER_CPU_RANGE=$(python3 -c "import json; print(json.load(open('configs/fts-benchmarks.json'))[0].get('server_cpu_range', '0-7'))")
          IO_THREADS=$(python3 -c "import json; print(json.load(open('configs/fts-benchmarks.json'))[0].get('io-threads', 8))")
          PORT=$(python3 -c "import json; print(json.load(open('configs/fts-benchmarks.json'))[0].get('port', 6379))")
          
          echo "Server config: cores=$SERVER_CPU_RANGE, io-threads=$IO_THREADS, port=$PORT"
          
          nohup taskset -c $SERVER_CPU_RANGE ../valkey/src/valkey-server \
            --port $PORT \
            --io-threads $IO_THREADS \
            --loadmodule ../valkey-search/.build-release/libsearch.so \
            --appendonly no \
            --save "" \
            --protected-mode no \
            > valkey-server.log 2>&1 &
          
          VALKEY_PID=$!
          echo "Valkey server started with PID: $VALKEY_PID"
          
          for i in {1..30}; do
            if ./valkey/src/valkey-cli ping > /dev/null 2>&1; then
              echo "✓ Valkey server is ready"
              break
            fi
            echo "Waiting for Valkey server... ($i/30)"
            sleep 2
          done
          
          if ./valkey/src/valkey-cli FT._LIST > /dev/null 2>&1; then
            echo "✓ valkey-search module loaded successfully"
          else
            echo "✗ valkey-search module not loaded"
            cat valkey-server.log
            exit 1
          fi

      - name: Run FTS benchmarks
        working-directory: valkey-perf-benchmark
        run: |
          # Clean previous results to avoid accumulation
          rm -rf results/search_tests
          mkdir -p results/search_tests
          
          echo "Running FTS benchmarks for groups: $TEST_GROUPS"
          PROFILING_FLAG=""
          if [[ "$ENABLE_PROFILING" == "true" ]]; then
            PROFILING_FLAG="--profiling"
          fi
          
          python benchmark.py \
            --module search \
            --valkey-path ../valkey \
            --target-ip 127.0.0.1 \
            --config configs/fts-benchmarks.json \
            --groups "$TEST_GROUPS" \
            $PROFILING_FLAG
          
          echo "✓ FTS benchmarks complete"
          ls -lh results/search_tests/metrics.json

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fts-benchmark-results
          path: valkey-perf-benchmark/results/search_tests
          retention-days: 30

      - name: Re-auth with AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}

      - name: Upload metrics to S3
        run: |
          SEARCH_SHA="${{ steps.search_commit.outputs.search_sha }}"
          echo "Uploading FTS metrics for valkey-search commit: $SEARCH_SHA"
          
          aws s3 cp "valkey-perf-benchmark/results/search_tests/metrics.json" \
            "s3://${{ secrets.AWS_S3_BUCKET }}/fts-results/$SEARCH_SHA/metrics.json"
          
          if [[ "$ENABLE_PROFILING" == "true" ]]; then
            aws s3 sync "valkey-perf-benchmark/results/search_tests/flamegraphs/" \
              "s3://${{ secrets.AWS_S3_BUCKET }}/fts-results/$SEARCH_SHA/flamegraphs/" \
              --exclude "*.perf.data"
          fi

      - name: Push metrics to PostgreSQL
        working-directory: valkey-perf-benchmark
        run: |
          PGPASSWORD=$(aws rds generate-db-auth-token \
            --hostname ${{ secrets.POSTGRESQL_ENDPOINT }} \
            --port 5432 \
            --region ${{ secrets.AWS_REGION }} \
            --username ${{ secrets.RDS_USERNAME }})
          
          python utils/push_to_postgres.py \
            --results-dir ./results/search_tests \
            --host ${{ secrets.POSTGRESQL_ENDPOINT }} \
            --port 5432 \
            --database ${{ secrets.RDS_DATABASE }} \
            --username ${{ secrets.RDS_USERNAME }} \
            --password "$PGPASSWORD" \
            --test-type fts \
            --module valkey-search \
            --module-commit "${{ steps.search_commit.outputs.search_sha }}"

      - name: Mark commit as complete
        working-directory: valkey-perf-benchmark
        run: |
          PGPASSWORD=$(aws rds generate-db-auth-token \
            --hostname ${{ secrets.POSTGRESQL_ENDPOINT }} \
            --port 5432 \
            --region ${{ secrets.AWS_REGION }} \
            --username ${{ secrets.RDS_USERNAME }})
          python utils/postgres_track_commits.py mark \
            --host ${{ secrets.POSTGRESQL_ENDPOINT }} \
            --port 5432 \
            --database ${{ secrets.RDS_DATABASE }} \
            --username ${{ secrets.RDS_USERNAME }} \
            --password "$PGPASSWORD" \
            --repo ../valkey-search \
            --status complete \
            --config-file configs/fts-benchmarks.json \
            ${{ steps.search_commit.outputs.search_sha }}

      - name: Shutdown Valkey server
        if: always()
        continue-on-error: true
        run: |
          echo "Shutting down Valkey server..."
          pkill -f "valkey-server" || echo "No valkey-server processes found"
          sleep 2

      - name: Cleanup
        if: always()
        continue-on-error: true
        run: |
          rm -rf valkey valkey-search valkey-perf-benchmark/results
          echo "✓ Cleanup complete (datasets preserved)"
